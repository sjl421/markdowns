# OPS平台的开发任务笔记

## 主要修改：

1. 多租户相关的东西；
   1. 租户管理；
2. 登录角色的限定，增加了ADB运维管理员和ADB租户管理员；
3. 告警信息；
4. 运维操作日志信息的修改；

## 1. 用户登录

1. 由于增加了多租户的功能，所以能够登录运维平台的人现在有两个：运维平台管理员和租户管理员，主要的区别：

   * 用户的鉴定流程

   * 用户界面展示的信息

     * 如果租户管理员同时具有运维管理员的权限，他所展示的页面在下拉框中会同时显示运维集群管理的东西和adb实例（租户）的信息；
     * 如果只是租户管理员，那么他的界面中将只有adb实例（租户）的信息；
     * 所以需要你在用户登录的时候鉴定其角色信息；

   * 当创建租户时需要验证得了流程（有图片）

     * 运维管理员首先会创建一批租户管理员，然后在创建租户的时候首先会去RM那里申请资源，然后该资源由该租户管理，所创建的租户信息需要保存在我本地的数据库中（自己维护）

     * 本地所保存的用户信息大致有：

       | id   | name         | admin        | adb_id | tenant_admin_role | ops_admin_role |      |
       | ---- | ------------ | ------------ | ------ | ----------------- | -------------- | ---- |
       | int  | varchar(255) | varchar(255) | int    | boolean           | boolean        |      |




### 问题分解：

创建租户：

1. dtcenter 验证：DTCenter是如何做用户管理的，如何创建用户，验证用户？
2. 在RM哪里申请相应的资源；调用RM api；
3. 在自己mysql数据库中创建用户；设计相应的表；
4. 创建用户成功；
5. ops的front和server管都走dtcenter；

租户登录： 

1. 租户登录，首先通过dtcenter验证；
2. 再通过本地mysql租户验证；
3. 判断当前用户角色，运维管理员 还是租户管理员；
4. 根绝不同的角色跳转到不同的页面；



## 2.告警部分

告警部分主要的分类有：

1. 硬件告警；
2. 租户实例的告警；
3. 租户内的服务的告警；

因为运维平台用户的角色有两种：所以对应的告警的展示也有两类：

1. 对于 运维平台管理员：展示1、2；
2. 对于 租户管理员：展示2、3；

告警部分的内容之前都是从ambari中取得，有一个脚本定时的从ambari（或这数据库中）去拉数据；



问题分解：

1. 如何获取当前所有的告警信息;
2. 通过不同的用户角色来展示不同的用户告警信息；

## 3.操作日志

运维的操作日志（记不清了）：

日志存储的格式需要改动；

可以封装自己的类（之前用的（好像是）node4j 来做的，然后由于？原因需要存储到数据库中（好像是如果是用node4j来做的话可以不存数据库））

如果自己封日志类的话就需要自己将每次的操作都写到数据库中（这个要求不是必须的）；

主要的问题出现在：

log4j的 MDC.put()方法中的 ThreadLocalMap中的问题；

log4j往mysql数据库中写的操作；



#### 原有的问题

request -> filer(将当前request的username，userId 获取后写入一个地方)，假如此时再起了两个线程，由于threadlocalmap本身的特点，会导致最终写入数据库的信息获取不到最原始的userName 和 userid的信息；

问题分解：

1. 首先搞懂原有的日志系统是如何工作的;
2. 构建自己的日志类，实现比他更好的日志类的功能；


@4.17 by 醋鱼

日志这里不怎么用改，就是要区分哪些需要上到集群管理，哪些不需要上到集群管理，做一下区分。

集群管理员：

* 运维日志（不用改）;
* 注： 运维管理员只能看到运维平台的操作日志，不能看到租户的操作日志；

租户管理员：

* 只能看到当前租户实例下的adb实例的操作日志
* 当前租户实例在所有主机上的都会有自己的一个空间，当前租户的所有的日志都会在这个空间下，到时候只要从这个空间中取当前租户的日志就可以了；

> 日志存放的地方：
>
> master： /home/gpadmin/data/master/tenant1,tenant2
>
> standby:/home/gpadmin/data/master/tenant1,teannt2
>
> segment:/




## 4. 整体的开发周期

3.29 ~ 4.15 （大概三周的样子）



## 5. 细节的一些地方

### 5.1 首页的修改

* 最顶端页面的修改；
* 操作日志（增加）

### 5.2 主机管理

* 主机管理，每次点击主机名后跳转的页面的内容，和史进沟通一下；




---

## 1. OPS-Multi Tenant Memo 

### 1. 资源视图

1. RM分配资源的时候是按照CPU，内存，disk按比例分配的;
2. 前端在计算显示条比例的时候只按照内存来计算，按照内存来计算所得到的结果（比例），拿这个比例来表征CPU，disk的使用情况来也是正确的（因为rm在分配资源的时候默认这些都是按照相同的比例来分配的）
3. 为了能够让用户的鼠标放到显示条上时能够显示CPU，内存，disk具体的大小，所以还需要将当前用户在当前host上的具体资源使用数量返回给前端；

### 2. 租户视图首页默认显示方式

显示当前集群中所有host中的资源使用情况，



### 3. 用户角色设定

用户的角色信息会分成两部分来存储：

1. DTCenter :

   DtCenter中记录了当前ops系统的运维平台管理员ops_admin和租户管理员：tenant_admin;

   ops-admin：同时可以具有租户管理员的角色，当他登录ops系统时，他能看到运维平台管理的页面和adb 实例的页面；

   tenant-admin：当他登录时只能考到adb实例的页面；

   在DTCenter中的db中存储的信息有：记录当前ops中允许有那些用户，每个用户的角色是什么样的；

   | user1 | ops_admin |
   | :---- | --------- |
   | user2 |           |
   | user3 |           |
   | ...   |           |

   dtcenter中不存起租户管理员这个角色（目前和我们联系最紧密的是运维平台管理员的角色），但是dtcenter中可以存在一些用户，他可以不具有明显和我们相关的角色（至少不具有运维平台管理员的角色），但是这些用户（管理员）我们可以在本地分配给其租户管理员的角色，注意：这是在我们本地分配给其的角色，DtCenter中并不存在这角色，这个角色的维护在我们本地的表中；

   @May 10, 2017 

   只有存在于dtcenter中的角色并且在本地mysql数据库中注册过的角色才可以登录运维平台；

   ​

   在gpops本地的数据库中记录当前所有的adb实例对应的管理员是谁

   | adb1 | user1 |
   | ---- | ----- |
   | adb2 | user1 |
   | adb3 | user2 |
   | adb4 | user3 |
   | adb5 | user2 |

   其中，user1是整个ops平台的管理员又是adb1的租户管理员；

---

@May 10， 2017

运维管理员： 

获取集群的信息通过Ambari；

获取租户的信息： 通过RM；

获取租户的状态：通过RM；

所以运维管理员的角色不需要获取GP的Connection；

租户管理员：

需要获取租户详细的信息，需要连接对应租户的gp，这种连接是通过gpadmin代持操作来完成；

对不同的租户需要动态的管理相应的gp连接池，key=租户ID；