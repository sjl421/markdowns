#ARP地址解析

地址解析协议，即ARP（Address Resolution Protocol），是根据[IP地址](https://baike.baidu.com/item/IP%E5%9C%B0%E5%9D%80)获取[物理地址](https://baike.baidu.com/item/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80)的一个[TCP/IP协议](https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE)。[主机](https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA)发送信息时将包含目标IP地址的ARP请求广播到网络上的所有主机，并接收返回消息，以此确定目标的物理地址；收到返回消息后将该IP地址和物理地址存入本机ARP缓存中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。地址解析协议是建立在网络中各个主机互相信任的基础上的，网络上的主机可以自主发送ARP应答消息，其他主机收到应答报文时不会检测该报文的真实性就会将其记入本机ARP缓存；由此攻击者就可以向某一主机发送伪ARP应答报文，使其发送的信息无法到达预期的主机或到达错误的主机，这就构成了一个[ARP欺骗](https://baike.baidu.com/item/ARP%E6%AC%BA%E9%AA%97)。[ARP命令](https://baike.baidu.com/item/ARP%E5%91%BD%E4%BB%A4)可用于查询本机ARP缓存中IP地址和[MAC地址](https://baike.baidu.com/item/MAC%E5%9C%B0%E5%9D%80)的对应关系、添加或删除静态对应关系等。相关协议有[RARP](https://baike.baidu.com/item/RARP)、[代理ARP](https://baike.baidu.com/item/%E4%BB%A3%E7%90%86ARP)。[NDP](https://baike.baidu.com/item/NDP)用于在[IPv6](https://baike.baidu.com/item/IPv6)中代替地址解析协议。

## 功能

地址解析协议由互联网工程任务组（[IETF](https://baike.baidu.com/item/IETF)）在1982年11月发布的RFC 826中描述制定。[1][ ]() 地址解析协议是[IPv4](https://baike.baidu.com/item/IPv4)中必不可少的协议，而IPv4是使用较为广泛的互联网协议版本（IPv6仍处在部署的初期）。

[OSI模型](https://baike.baidu.com/item/OSI%E6%A8%A1%E5%9E%8B)把网络工作分为七层，IP地址在OSI模型的第三层，MAC地址在第二层，彼此不直接打交道。在通过[以太网](https://baike.baidu.com/item/%E4%BB%A5%E5%A4%AA%E7%BD%91)发送IP数据包时，需要先封装第三层（32位IP地址）、第二层（48位MAC地址）的报头，但由于发送时只知道目标IP地址，不知道其MAC地址，又不能跨第二、三层，所以需要使用地址解析协议。使用地址解析协议，可根据网络层IP数据包包头中的IP地址信息解析出目标硬件地址（MAC地址）信息，以保证通信的顺利进行。[2][ ]()

## 原理

### 工作过程

主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；

主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；

当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：

第1步：根据主机A上的[路由表](https://baike.baidu.com/item/%E8%B7%AF%E7%94%B1%E8%A1%A8)内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。

第2步：如果主机A在ARP缓存中没有找到映射，它将询问192.168.1.2的硬件地址，从而将ARP请求帧广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。

第3步：主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址[映射](https://baike.baidu.com/item/%E6%98%A0%E5%B0%84)添加到本地ARP缓存中。

第4步：主机B将包含其MAC地址的ARP回复消息直接发送回主机A。

第5步：当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有[生存期](https://baike.baidu.com/item/%E7%94%9F%E5%AD%98%E6%9C%9F)的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了。

### 工作要素：ARP缓存

ARP缓存是个用来储存IP地址和MAC地址的[缓冲区](https://baike.baidu.com/item/%E7%BC%93%E5%86%B2%E5%8C%BA)，其本质就是一个IP地址-->MAC地址的对应表，表中每一个条目分别记录了网络上其他主机的IP地址和对应的MAC地址。每一个以太网或[令牌环](https://baike.baidu.com/item/%E4%BB%A4%E7%89%8C%E7%8E%AF)[网络适配器](https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E9%80%82%E9%85%8D%E5%99%A8)都有自己单独的表。当地址解析协议被询问一个已知IP地址[节点](https://baike.baidu.com/item/%E8%8A%82%E7%82%B9)的MAC地址时，先在ARP缓存中查看，若存在，就直接返回与之对应的MAC地址，若不存在，才发送ARP请求向[局域网](https://baike.baidu.com/item/%E5%B1%80%E5%9F%9F%E7%BD%91)查询。

为使广播量最小，ARP维护IP地址到MAC地址映射的缓存以便将来使用。ARP缓存可以包含动态和静态项目。动态项目随时间推移自动添加和删除。每个动态ARP缓存项的潜在[生命周期](https://baike.baidu.com/item/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F)是10分钟。新加到缓存中的项目带有[时间戳](https://baike.baidu.com/item/%E6%97%B6%E9%97%B4%E6%88%B3)，如果某个项目添加后2分钟内没有再使用，则此项目过期并从ARP缓存中删除；如果某个项目已在使用，则又收到2分钟的生命周期；如果某个项目始终在使用，则会另外收到2分钟的生命周期，一直到10分钟的最长生命周期。静态项目一直保留在缓存中，直到重新启动计算机为止。

### 工作媒介：报文

地址解析协议是通过[报文](https://baike.baidu.com/item/%E6%8A%A5%E6%96%87)工作的。报文包括如下字段：

| 硬件类型           | 协议类型           |      |
| -------------- | -------------- | ---- |
| 硬件地址长度         | 协议长度           | 操作类型 |
| 发送方硬件地址（0-3字节） |                |      |
| 发送方硬件地址（4-5字节） | 发送方IP地址（0-1字节） |      |
| 发送方IP地址（2-3字节） | 目标硬件地址（0-1字节）  |      |
| 目标硬件地址（2-5字节）  |                |      |
| 目标IP地址（0-3字节）  |                |      |

硬件类型：指明了发送方想知道的硬件[接口](https://baike.baidu.com/item/%E6%8E%A5%E5%8F%A3)类型，以太网的值为1；

协议类型：指明了发送方提供的高层[协议](https://baike.baidu.com/item/%E5%8D%8F%E8%AE%AE/13020269)类型，IP为0800（16进制）；

硬件地址长度和协议长度：指明了硬件地址和高层协议地址的长度，这样ARP报文就可以在任意硬件和任意协议的网络中使用；

操作类型：用来表示这个报文的类型，ARP请求为1，ARP响应为2，RARP请求为3，RARP响应为4；

发送方硬件地址（0-3字节）：源主机硬件地址的前3个字节；

发送方硬件地址（4-5字节）：源主机硬件地址的后3个字节；

发送方IP地址（0-1字节）：源主机硬件地址的前2个字节；

发送方IP地址（2-3字节）：源主机硬件地址的后2个字节；

目标硬件地址（0-1字节）：目的主机硬件地址的前2个字节；

目标硬件地址（2-5字节）：目的主机硬件地址的后4个字节；

目标IP地址（0-3字节）：目的主机的IP地址。	

## 应用

### ARP命令

ARP缓存中包含一个或多个表，它们用于存储IP地址及其经过解析的MAC地址。ARP命令用于查询本机ARP缓存中IP地址-->MAC地址的对应关系、添加或删除静态对应关系等。如果在没有参数的情况下使用，[ARP命令](https://baike.baidu.com/item/ARP%E5%91%BD%E4%BB%A4)将显示帮助信息。

**常见用法**

arp -a或arp –g

用于查看缓存中的所有项目。-a和-g参数的结果是一样的，多年来-g一直是UNIX平台上用来显示ARP缓存中所有项目的选项，而Windows用的是arp -a（-a可被视为all，即全部的意思），但它也可以接受比较传统的-g选项。

arp -a Ip

如果有多个网卡，那么使用arp -a加上接口的IP地址，就可以只显示与该接口相关的ARP缓存项目。

arp -s Ip 物理地址

可以向ARP缓存中人工输入一个静态项目。该项目在计算机引导过程中将保持有效状态，或者在出现错误时，人工配置的物理地址将自动更新该项目。

arp -d Ip

使用该命令能够人工删除一个静态项目.



原文地址:https://baike.baidu.com/item/ARP/609343?fr=aladdin