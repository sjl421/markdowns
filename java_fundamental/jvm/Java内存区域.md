# Java内存区域

## 2.1 运行时的数据库

1. 程序计数器

   * 当前线程所执行的字节码的行号指示器；
   * 线程私有的；
   * 如果执行的是java方法，记录的是正在执行的虚拟机字节码指令的地址；如果执行的是Native方法，计数器值为空；
   * 是Java虚拟机规范中为一个没有对规定任何OOM的区域；

2. Java 虚拟机栈


### 对象在内存中的存储

java对象在内存中的存储布局可分为3部分：对象头（header），示例数据（Instance data）和对齐数据（padding）；

对象头： 存储两部分数据：

 第一部分用于存储对象自身运行时的数据，如：哈希码，GC分代年龄，锁状态标志，线程持有的锁，偏向线程ID，偏向时间戳等，在32bit和64bit的虚拟机中长度为分别32bit和64bit，官方成为Mark Word 。

第二部分： 类型指针，即对象指向它的类型元数据的指针，虚拟机通过这个指针确定这个对对象数据哪个类的示例。

如果对象是一个数据，那么对象头中还必须有一块记录数组长度的数据。

### 对象的访问定位

java的stack中存储了对象的引用，java是通过该引用来操作堆上的具体对象。在通过stack上的引用来访问具体的对象时，中间主要通过两种方式来定位，访问堆中 的对象的具体数据。视具体的虚拟机而定，主流的访问方式有： 使用句柄和直接指针访问；

* 句柄访问： java堆中会划分出一块内存来作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象示例数据与类型数据各自的具体地址信息。
* 直接指针访问： java堆对象的布局中就必须考虑如何访问访问类型数据的相关信息，而reference中存储的就是对象地址。

优缺点：

句柄访问的好处就是reference中存储的是稳定的句柄地址，在对象移动（垃圾收集时移动对象是非常普遍的行为）时只会改变句柄中的示例数据指针，而reference本身不需要修改。

直接指针访问的最大好处就是速度快，节省了一次指针定位的时间开销。

Hotspot使用的第二种的访问方式。



